{% extends "shop/base.html" %}

{% block content %}

{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'shop/shop_style.css' %}">

    <div class="item">
        <img src="{{item.images.first.image.url}}" alt="">
        <p>{{ item.title }}</p>
        <button id="button{{forloop.counter}}" onclick="addCookieItem()">Add to Cart</button>
    </div>

<script>
    async function addCookieItem(){
        console.log('Adding cookies')

        var itemId = {{item.id}}
        var cartIndex =  Object.keys(cart).length + 1
        console.log(cartIndex)

        // Create Dict for new item
        itemDict = {
            itemId: itemId,
            style_groups: {},
        }
        itemDict['style_groups'] = {}

        {% for style_group in item.stylegroup_set.all %}
        itemDict['style_groups']['{{style_group.type}}'] = '{{style_group.style_set.first}}'
        {% endfor %}

        console.log(itemDict)

        // Check if item already exists in cart and either increase quantity of that item or set quantity = 1
        for(let k in cart){
            console.log('checking item')
            if(cart[k]['itemId'] == itemId){
                currentItemDict = cart[k]
                currentItemQuantity = cart[k]['quantity']
                itemDict['quantity'] = currentItemQuantity
                if(JSON.stringify(currentItemDict) === JSON.stringify(itemDict)){
                    console.log('fit found')
                    cartIndex = k
                    /*delete cart[k]*/
                    itemDict['quantity'] = currentItemQuantity + 1
                }
            }
        }

        if(!itemDict.hasOwnProperty('quantity')){
            itemDict['quantity'] = 1
        }

        cart[cartIndex] = itemDict

        console.log('CART:', cart)
        document.cookie ='cart=' + JSON.stringify(cart) + ";domain=;path=/"

        getCartCount()

        openCartPreview()
        let delayres = await delay(2000)
        closeCartPreview()

    }

</script>


{% endblock %}